<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Firmar PDF con PDF.js</title>
<style>
  #pdfContainer {
    position: relative;
    border: 1px solid #ccc;
    /* No fijo ancho ni alto para que crezca según el canvas PDF */
    display: inline-block; /* Que se ajuste al contenido */
  }

  #pdfCanvas {
    position: relative; /* Ocupa espacio normalmente */
    display: block;
    user-select: none;
    width: 100%; /* El contenedor toma el tamaño real del canvas */
    height: auto;
  }

  #sigCanvas {
    position: absolute;
    top: 0; left: 0;
    pointer-events: auto;
    cursor: crosshair;
    border: 1px solid transparent;
    /* Importante: ancho y alto serán ajustados desde JS para coincidir */
  }
</style>
</head>
<body>

<h1>Firmar PDF con PDF.js</h1>

<input type="file" id="pdfInput" accept="application/pdf" />

<div id="pdfContainer">
  <canvas id="pdfCanvas"></canvas>
  <canvas id="sigCanvas"></canvas>
</div>

<button onclick="enviar()">Firmar y descargar</button>
<button id="prevPage">Anterior</button>
<button id="nextPage">Siguiente</button>
<span>Página: <span id="pageNum">1</span> / <span id="pageCount">--</span></span>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script>
const pdfInput = document.getElementById('pdfInput');
const pdfCanvas = document.getElementById('pdfCanvas');
const sigCanvas = document.getElementById('sigCanvas');
const pdfContainer = document.getElementById('pdfContainer');
const pdfCtx = pdfCanvas.getContext('2d');
let sigCtx = sigCanvas.getContext('2d');

let pdfDoc = null;
let currentPage = 1;
let dibujando = false;

// Función para obtener posición del mouse sobre el canvas de firma
function getMousePos(canvas, evt) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  return {
    x: (evt.clientX - rect.left) * scaleX,
    y: (evt.clientY - rect.top) * scaleY
  };
}
const prevPageBtn = document.getElementById('prevPage');
const nextPageBtn = document.getElementById('nextPage');
const pageNumSpan = document.getElementById('pageNum');
const pageCountSpan = document.getElementById('pageCount');

prevPageBtn.addEventListener('click', () => {
  if (currentPage <= 1) return;
  currentPage--;
  renderPage(currentPage);
});

nextPageBtn.addEventListener('click', () => {
  if (!pdfDoc) return;
  if (currentPage >= pdfDoc.numPages) return;
  currentPage++;
  renderPage(currentPage);
});

async function renderPage(pageNum) {
  const page = await pdfDoc.getPage(pageNum);
  // (Tu código existente para renderizar la página)

  // Actualiza el texto de la página actual y total
  pageNumSpan.textContent = currentPage;
  pageCountSpan.textContent = pdfDoc.numPages;

  // También limpia la firma para la nueva página
  sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
}
// Eventos para dibujar la firma
sigCanvas.addEventListener('mousedown', e => {
  dibujando = true;
  const pos = getMousePos(sigCanvas, e);
  sigCtx.beginPath();
  sigCtx.moveTo(pos.x, pos.y);
});
sigCanvas.addEventListener('mousemove', e => {
  if (!dibujando) return;
  const pos = getMousePos(sigCanvas, e);
  sigCtx.lineTo(pos.x, pos.y);
  sigCtx.stroke();
});
sigCanvas.addEventListener('mouseup', () => { dibujando = false; });
sigCanvas.addEventListener('mouseleave', () => { dibujando = false; });

// Cuando se carga un PDF nuevo
pdfInput.addEventListener('change', async () => {
  const file = pdfInput.files[0];
  if (!file) return;

  const fileReader = new FileReader();
  fileReader.onload = async function() {
    const typedarray = new Uint8Array(this.result);
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';
    pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
    currentPage = 1;
    renderPage(currentPage);
  };
  fileReader.readAsArrayBuffer(file);
});

async function renderPage(pageNum) {
  const page = await pdfDoc.getPage(pageNum);
  const dpr = window.devicePixelRatio || 1;

  // Viewport con escala para alta resolución (pantallas retina)
  const viewport = page.getViewport({ scale: 1 }); // escala 1 normal para CSS

  // Ajustamos tamaño del canvas para DPI físico (multiplicamos)
  pdfCanvas.width = viewport.width * dpr;
  pdfCanvas.height = viewport.height * dpr;

  // Ajustamos tamaño CSS para que se vea correcto (sin escala dpr)
  pdfCanvas.style.width = viewport.width + 'px';
  pdfCanvas.style.height = viewport.height + 'px';

  // Igual para canvas firma: tamaño interno y CSS
  sigCanvas.width = viewport.width * dpr;
  sigCanvas.height = viewport.height * dpr;
  sigCanvas.style.width = viewport.width + 'px';
  sigCanvas.style.height = viewport.height + 'px';

  // Ajustamos el contenedor para que tenga el tamaño real del PDF (CSS)
  pdfContainer.style.width = viewport.width + 'px';
  pdfContainer.style.height = viewport.height + 'px';

  // Limpiamos el canvas PDF y escalamos contexto para dpr
  pdfCtx.setTransform(1, 0, 0, 1, 0, 0);
  pdfCtx.scale(dpr, dpr);

  // Configuramos el contexto de firma
  sigCtx = sigCanvas.getContext('2d');
  sigCtx.lineJoin = 'round';
  sigCtx.lineCap = 'round';
  sigCtx.strokeStyle = 'rgba(0,0,0,0.8)';
  sigCtx.lineWidth = 2;
  sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);

  // Dibujamos la página del PDF
  const renderContext = {
    canvasContext: pdfCtx,
    viewport: viewport
  };
  await page.render(renderContext).promise;
}

async function enviar() {
  if (!pdfDoc) {
    alert("Primero cargá un PDF");
    return;
  }
  const firmaBase64 = sigCanvas.toDataURL('image/png');
  alert("Firma capturada!\nDimensiones: " + sigCanvas.width + "x" + sigCanvas.height);
}
</script>


</body>
</html>